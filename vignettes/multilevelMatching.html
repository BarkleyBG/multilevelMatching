<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Shu Yang" />

<meta name="date" content="2017-05-17" />

<title>multilevelMatching Tutorial</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">multilevelMatching Tutorial</h1>
<h4 class="author"><em>Shu Yang</em></h4>
<h4 class="date"><em>2017-05-17</em></h4>



<div id="title" class="section level3">
<h3>Title</h3>
<p>Propensity Score Matching and Subclassification in Observational Studies with Multi-level Treatments</p>
</div>
<div id="description" class="section level3">
<h3>Description</h3>
<p>In setting with Multi-level treatments, our goal is to estimate pairwise average treatment effects from a common population using matching methods.</p>
<p>This goal can not be acheived by matching one treatment with another one at a time, since the pairwise matched samples may differ from the target population systematically, and thus they are not compatitable. One implication is that from this approach, it is possible that treatment A is better than treatment B, treatment B is better than treatment C, and treatment C is better than treatment A.</p>
<p>We focus on estimating the average values of potential outcomes for each treatment level by matching methods, which facilitate estimation of pairwise average treatment effects for a common population.</p>
<p>The estimation methods include generalized propensity score (GPS) matching, GPS stratification, matching with the full set of covariates, matching with the full set of GPS vector. Note that GPS matching and GPS straticication only require matching on a scalar function when estimating the average value of the potential outcome at a particular treatment level, which reduces the matching dimension to one, regardless of the number of covariates and the number of treatment levels.</p>
<p>In order to ensure sufficient overlap, Crump et al. (2009)â€™s trimming method can be extended to this setting as well.</p>
</div>
<div id="install" class="section level3">
<h3>Install</h3>
<p>with <code>devtools</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;shuyang1987/multilevelMatching&quot;</span>)</code></pre></div>
</div>
<div id="use" class="section level3">
<h3>Use</h3>
<p>There are only three functions in this package. <code>multilevelMatchX()</code>,; <code>multilevelGPSMatch()</code>, ; <code>multilevelGPSStratification()</code>  make super awesome illustrations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(multilevelMatching)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">X&lt;-<span class="kw">c</span>(<span class="fl">5.5</span>,<span class="fl">10.6</span>,<span class="fl">3.1</span>,<span class="fl">8.7</span>,<span class="fl">5.1</span>,<span class="fl">10.2</span>,<span class="fl">9.8</span>,<span class="fl">4.4</span>,<span class="fl">4.9</span>)
Y&lt;-<span class="kw">c</span>(<span class="dv">102</span>,<span class="dv">105</span>,<span class="dv">120</span>,<span class="dv">130</span>,<span class="dv">100</span>,<span class="dv">80</span>,<span class="dv">94</span>,<span class="dv">108</span>,<span class="dv">96</span>)
W&lt;-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)
<span class="kw">multilevelMatchX</span>(Y,W,X)</code></pre></div>
<pre><code>## Warning in prepareData(Y = Y, W = W, X = X, match_method = match_method):
## It is recommended that X is a matrix. X will be coerced to a matrix.</code></pre>
<pre><code>## $results
##         Param Trt1 Trt2   Estimate   Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2 -10.666667   9.111111             NA
## 2 EY(3)-EY(1)    1    3   6.666667 615.580247             NA
## 3 EY(3)-EY(2)    2    3  17.333333 613.925926             NA
## 
## $analysis_idx
## NULL
## 
## $mu
##   Param Trt Estimate
## 1 EY(1)   1 106.6667
## 2 EY(2)   2  96.0000
## 3 EY(3)   3 113.3333
## 
## $impute_mat
##       [,1] [,2] [,3]
##  [1,]  102  100  130
##  [2,]  105   94   80
##  [3,]  120   96  130
##  [4,]  105   94  130
##  [5,]  102  100  130
##  [6,]  105   94   80
##  [7,]  105   94   80
##  [8,]  108   96  130
##  [9,]  108   96  130
## 
## $estimate_args
## $estimate_args$trtlevels
## [1] 1 2 3
## 
## $estimate_args$meanw
## [1] 106.6667  96.0000 113.3333
## 
## $estimate_args$trtnumber
## [1] 3
## 
## $estimate_args$taunumber
## [1] 3
## 
## $estimate_args$N
## [1] 9
## 
## $estimate_args$Yiw
##       [,1] [,2] [,3]
##  [1,]  102  100  130
##  [2,]  105   94   80
##  [3,]  120   96  130
##  [4,]  108   96  130
##  [5,]  102  100  130
##  [6,]  105   94   80
##  [7,]  108   96  130
##  [8,]  105   94  130
##  [9,]  105   94   80
## 
## $estimate_args$Kiw
##       [,1]
##  [1,]    1
##  [2,]    3
##  [3,]    0
##  [4,]    1
##  [5,]    1
##  [6,]    3
##  [7,]    2
##  [8,]    5
##  [9,]    2
## 
## $estimate_args$sigsqiw
##         [,1]
##  [1,]   18.0
##  [2,]    4.5
##  [3,]   72.0
##  [4,]   18.0
##  [5,]    8.0
##  [6,]   18.0
##  [7,]    8.0
##  [8,] 1250.0
##  [9,] 1250.0
## 
## $estimate_args$W
## [1] 1 1 1 1 2 2 2 3 3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="dv">0</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>)</code></pre></div>
<pre><code>## Warning in prepareData(Y = Y, W = W, X = X, match_method = match_method, :
## It is recommended that X is a matrix. X will be coerced to a matrix.</code></pre>
<pre><code>## $results
##         Param Trt1 Trt2   Estimate   Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2 -10.444444   8.545953       8.302024
## 2 EY(3)-EY(1)    1    3   6.666667 616.913580     411.456234
## 3 EY(3)-EY(2)    2    3  17.111111 611.122085     434.247037
## 
## $analysis_idx
## NULL
## 
## $mu
##   Param Trt  Estimate
## 1 EY(1)   1 106.66667
## 2 EY(2)   2  96.22222
## 3 EY(3)   3 113.33333
## 
## $impute_mat
##       [,1] [,2] [,3]
##  [1,]  102  100  130
##  [2,]  105   94   80
##  [3,]  120   96  130
##  [4,]  105   96  130
##  [5,]  102  100  130
##  [6,]  105   94   80
##  [7,]  105   94   80
##  [8,]  108   96  130
##  [9,]  108   96  130
## 
## $estimate_args
## $estimate_args$trtlevels
## [1] 1 2 3
## 
## $estimate_args$meanw
## [1] 106.66667  96.22222 113.33333
## 
## $estimate_args$trtnumber
## [1] 3
## 
## $estimate_args$taunumber
## [1] 3
## 
## $estimate_args$N
## [1] 9
## 
## $estimate_args$Yiw
##       [,1] [,2] [,3]
##  [1,]  102  100  130
##  [2,]  105   94   80
##  [3,]  120   96  130
##  [4,]  108   96  130
##  [5,]  102  100  130
##  [6,]  105   94   80
##  [7,]  108   96  130
##  [8,]  105   96  130
##  [9,]  105   94   80
## 
## $estimate_args$Kiw
##       [,1]
##  [1,]    1
##  [2,]    3
##  [3,]    0
##  [4,]    1
##  [5,]    1
##  [6,]    2
##  [7,]    3
##  [8,]    5
##  [9,]    2
## 
## $estimate_args$sigsqiw
##         [,1]
##  [1,]   18.0
##  [2,]    4.5
##  [3,]   72.0
##  [4,]   72.0
##  [5,]    8.0
##  [6,]    2.0
##  [7,]    8.0
##  [8,] 1250.0
##  [9,] 1250.0
## 
## $estimate_args$W
## [1] 1 1 1 1 2 2 2 3 3
## 
## 
## $AI2012_args
## $AI2012_args$Cvec
##      [,1]        [,2] [,3]        [,4]
## [1,]    0  0.04536431    0  -1.4222059
## [2,]    0 -1.02393228    0   0.7915606
## [3,]    0 12.50001000    0 -29.1666552
## 
## $AI2012_args$vcov_coeff
##               2:(Intercept)         2:X 3:(Intercept)         3:X
## 2:(Intercept)     4.2775709 -0.58729558     1.9261788 -0.27779100
## 2:X              -0.5872956  0.09365331    -0.2826604  0.04689727
## 3:(Intercept)     1.9261788 -0.28266040    19.5121429 -2.10608615
## 3:X              -0.2777910  0.04689727    -2.1060861  0.24229598</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="dv">1</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>)</code></pre></div>
<pre><code>## Warning in prepareData(Y = Y, W = W, X = X, match_method = match_method, :
## It is recommended that X is a matrix. X will be coerced to a matrix.</code></pre>
<pre><code>## $results
##         Param Trt1 Trt2 Estimate   Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2   -9.375   7.794922       5.072057
## 2 EY(3)-EY(1)    1    3    5.875 582.654297     383.848575
## 3 EY(3)-EY(2)    2    3   15.250 576.304688     430.978089
## 
## $analysis_idx
## $analysis_idx$indices_kept
## 1 2 4 5 6 7 8 9 
## 1 2 4 5 6 7 8 9 
## 
## $analysis_idx$indices_dropped
## [1] 3
## 
## 
## $mu
##   Param Trt Estimate
## 1 EY(1)   1  105.375
## 2 EY(2)   2   96.000
## 3 EY(3)   3  111.250
## 
## $impute_mat
##      [,1] [,2] [,3]
## [1,]  102  100  130
## [2,]  105   94   80
## [3,]  102   94  130
## [4,]  108  100  130
## [5,]  105   94   80
## [6,]  105   94   80
## [7,]  108   96  130
## [8,]  108   96  130
## 
## $estimate_args
## $estimate_args$trtlevels
## [1] 1 2 3
## 
## $estimate_args$meanw
## [1] 105.375  96.000 111.250
## 
## $estimate_args$trtnumber
## [1] 3
## 
## $estimate_args$taunumber
## [1] 3
## 
## $estimate_args$N
## [1] 8
## 
## $estimate_args$Yiw
##      [,1] [,2] [,3]
## [1,]  102  100  130
## [2,]  105   94   80
## [3,]  108   96  130
## [4,]  108  100  130
## [5,]  105   94   80
## [6,]  108   96  130
## [7,]  102   94  130
## [8,]  105   94   80
## 
## $estimate_args$Kiw
##      [,1]
## [1,]    1
## [2,]    2
## [3,]    2
## [4,]    1
## [5,]    3
## [6,]    1
## [7,]    4
## [8,]    2
## 
## $estimate_args$sigsqiw
##        [,1]
## [1,]   18.0
## [2,]    4.5
## [3,]   18.0
## [4,]    8.0
## [5,]   18.0
## [6,]    8.0
## [7,] 1250.0
## [8,] 1250.0
## 
## $estimate_args$W
## [1] 1 1 1 2 2 2 3 3
## 
## 
## $AI2012_args
## $AI2012_args$Cvec
##      [,1]      [,2] [,3]       [,4]
## [1,]    0  0.277578    0  -1.210117
## [2,]    0 -5.121661    0   3.139818
## [3,]    0 14.062674    0 -28.124873
## 
## $AI2012_args$vcov_coeff
##               2:(Intercept)         2:X 3:(Intercept)         3:X
## 2:(Intercept)     6.1334608 -0.81407641     3.0403215 -0.39723734
## 2:X              -0.8140764  0.12126318    -0.3960346  0.05811916
## 3:(Intercept)     3.0403215 -0.39603457    21.2168440 -2.27970447
## 3:X              -0.3972373  0.05811916    -2.2797045  0.25886828</code></pre>
<p>The user can supply propensity scores through the <code>X</code> argument by setting <code>GPSM=&quot;existing&quot;</code> in <code>multilevelGPSMatch()</code> or <code>multilevelGPSStratification()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pr_w1 &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="fl">0.3</span>,<span class="fl">0.5</span>), <span class="dt">replace=</span><span class="ot">TRUE</span>, <span class="dt">size=</span><span class="kw">length</span>(W))
pr_w2 &lt;-<span class="st"> </span>(<span class="dv">1</span>-pr_w1)/<span class="dv">3</span>
pr_w3 &lt;-<span class="st"> </span><span class="dv">1</span>-(pr_w1+pr_w2)
existing_GPS_matrix &lt;-<span class="st"> </span><span class="kw">cbind</span>(pr_w1, pr_w2,pr_w3)
<span class="co">#the following checks are also carried out under the hood</span>
<span class="kw">nrow</span>(existing_GPS_matrix)==<span class="kw">length</span>(W)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ncol</span>(existing_GPS_matrix)==<span class="kw">length</span>(<span class="kw">unique</span>(W))</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all</span>(<span class="kw">rowSums</span>(existing_GPS_matrix)==<span class="dv">1</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">multilevelGPSMatch</span>(<span class="dt">Y=</span>Y,<span class="dt">W=</span>W,<span class="dt">X=</span>existing_GPS_matrix,<span class="dt">Trimming=</span><span class="dv">0</span>,<span class="dt">GPSM=</span><span class="st">&quot;existing&quot;</span>)</code></pre></div>
<pre><code>## $results
##         Param Trt1 Trt2  Estimate  Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2 -8.888889  25.22085             NA
## 2 EY(3)-EY(1)    1    3  6.666667 627.87654             NA
## 3 EY(3)-EY(2)    2    3 15.555556 625.85460             NA
## 
## $analysis_idx
## NULL
## 
## $mu
##   Param Trt  Estimate
## 1 EY(1)   1 106.66667
## 2 EY(2)   2  97.77778
## 3 EY(3)   3 113.33333
## 
## $impute_mat
##       [,1] [,2] [,3]
##  [1,]  102   96   80
##  [2,]  105  100  130
##  [3,]  120  100  130
##  [4,]  105  100  130
##  [5,]  105  100   80
##  [6,]  105  100   80
##  [7,]  108   94  130
##  [8,]  108   94  130
##  [9,]  102   96  130
## 
## $estimate_args
## $estimate_args$trtlevels
## [1] 1 2 3
## 
## $estimate_args$meanw
## [1] 106.66667  97.77778 113.33333
## 
## $estimate_args$trtnumber
## [1] 3
## 
## $estimate_args$taunumber
## [1] 3
## 
## $estimate_args$N
## [1] 9
## 
## $estimate_args$Yiw
##       [,1] [,2] [,3]
##  [1,]  102   96   80
##  [2,]  105  100  130
##  [3,]  120  100  130
##  [4,]  108   94  130
##  [5,]  105  100   80
##  [6,]  108   94  130
##  [7,]  102   96  130
##  [8,]  105  100  130
##  [9,]  105  100   80
## 
## $estimate_args$Kiw
##       [,1]
##  [1,]    1
##  [2,]    3
##  [3,]    0
##  [4,]    1
##  [5,]    4
##  [6,]    1
##  [7,]    1
##  [8,]    5
##  [9,]    2
## 
## $estimate_args$sigsqiw
##         [,1]
##  [1,]   18.0
##  [2,]  112.5
##  [3,]  112.5
##  [4,]   18.0
##  [5,]   18.0
##  [6,]    2.0
##  [7,]    2.0
##  [8,] 1250.0
##  [9,] 1250.0
## 
## $estimate_args$W
## [1] 1 1 1 1 2 2 2 3 3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">111</span>)
n    &lt;-<span class="st"> </span><span class="dv">5000</span>*<span class="dv">6</span>
<span class="co"># X1-X3 3 MVN var 2, 1, 1, covars 1, -1, -.5</span>
vars   &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)
covars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,-<span class="dv">1</span>,-.<span class="dv">5</span>)
mu     &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)
tau    &lt;-<span class="st"> </span><span class="dv">1</span>
Sigma &lt;-<span class="st"> </span><span class="kw">diag</span>(vars)
Sigma[<span class="dv">2</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span>Sigma[<span class="dv">1</span>,<span class="dv">2</span>] &lt;-<span class="st"> </span>covars[<span class="dv">1</span>]
Sigma[<span class="dv">3</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span>Sigma[<span class="dv">1</span>,<span class="dv">3</span>] &lt;-<span class="st"> </span>covars[<span class="dv">2</span>]
Sigma[<span class="dv">3</span>,<span class="dv">2</span>] &lt;-<span class="st"> </span>Sigma[<span class="dv">2</span>,<span class="dv">3</span>] &lt;-<span class="st"> </span>covars[<span class="dv">3</span>]
trt1 &lt;-<span class="st"> </span><span class="dv">100</span>; trt1</code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trt2 &lt;-<span class="st"> </span><span class="dv">100</span>; trt2</code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trt3 &lt;-<span class="st"> </span><span class="dv">100</span>; trt3</code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># draw Xs</span>
X13 &lt;-<span class="st"> </span>MASS::<span class="kw">mvrnorm</span>(n,<span class="dt">mu=</span>mu,<span class="dt">Sigma=</span>Sigma, <span class="dt">empirical =</span> <span class="ot">FALSE</span>)
X1 &lt;-<span class="st"> </span>X13[,<span class="dv">1</span>]
X2 &lt;-<span class="st"> </span>X13[,<span class="dv">2</span>]
X3 &lt;-<span class="st"> </span>X13[,<span class="dv">3</span>]
X4 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,-<span class="dv">3</span>,<span class="dv">3</span>)
X5 &lt;-<span class="st"> </span><span class="kw">rchisq</span>(n, <span class="dt">df=</span><span class="dv">1</span>)
X6 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n,<span class="dt">size=</span><span class="dv">1</span>,<span class="dt">prob=</span>.<span class="dv">5</span>)

xb2 &lt;-<span class="st"> </span><span class="fl">0.1</span>*(X1^<span class="dv">2</span>+X2+X3+X4+X5+X6)
xb3 &lt;-<span class="st"> </span><span class="fl">0.1</span>*(X1+X2^<span class="dv">2</span>+X3^<span class="dv">2</span>+X4+X5+X6)
exb2&lt;-<span class="kw">exp</span>(xb2)
exb3&lt;-<span class="kw">exp</span>(xb3)
pi1&lt;-<span class="dv">1</span>/(<span class="dv">1</span>+<span class="kw">exp</span>(xb2)+<span class="kw">exp</span>(xb3))
pi2&lt;-<span class="kw">exp</span>(xb2)/(<span class="dv">1</span>+<span class="kw">exp</span>(xb2)+<span class="kw">exp</span>(xb3))
pi3&lt;-<span class="kw">exp</span>(xb3)/(<span class="dv">1</span>+<span class="kw">exp</span>(xb2)+<span class="kw">exp</span>(xb3))
pi&lt;-<span class="kw">cbind</span>(pi1,pi2,pi3)
<span class="kw">apply</span>(pi,<span class="dv">2</span>,mean)</code></pre></div>
<pre><code>##       pi1       pi2       pi3 
## 0.2637337 0.3681104 0.3681559</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">W&lt;-<span class="kw">matrix</span>(<span class="ot">NA</span>,n,<span class="dv">4</span>)
<span class="kw">colnames</span>(W)   &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>,<span class="st">&quot;W2&quot;</span>,<span class="st">&quot;W3&quot;</span>,<span class="st">&quot;W&quot;</span>)
for(kk in <span class="dv">1</span>:n){
    W[kk,<span class="dv">1</span>:<span class="dv">3</span>]&lt;-<span class="kw">rmultinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dt">prob =</span> pi[kk,])
}

sim.dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(W,X1,X2,X3,X4,X5,X6)
trt1.keep &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(sim.dat$W1==<span class="dv">1</span>),trt1,<span class="dt">replace=</span><span class="ot">FALSE</span>)
trt2.keep &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(sim.dat$W2==<span class="dv">1</span>),trt2,<span class="dt">replace=</span><span class="ot">FALSE</span>)
trt3.keep &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(sim.dat$W3==<span class="dv">1</span>),trt3,<span class="dt">replace=</span><span class="ot">FALSE</span>)
sim.dat &lt;-<span class="st"> </span>sim.dat[<span class="kw">c</span>(trt1.keep,trt2.keep,trt3.keep),]
sim.dat[,<span class="st">&quot;W&quot;</span>]&lt;-sim.dat[,<span class="st">&quot;W1&quot;</span>]+<span class="dv">2</span>*sim.dat[,<span class="st">&quot;W2&quot;</span>]+<span class="dv">3</span>*sim.dat[,<span class="st">&quot;W3&quot;</span>]
sim.dat[,<span class="st">&quot;W&quot;</span>]&lt;-<span class="kw">as.factor</span>(sim.dat[,<span class="st">&quot;W&quot;</span>])
W &lt;-<span class="st"> </span>sim.dat[,<span class="st">&quot;W&quot;</span>]
X &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(sim.dat[,<span class="kw">names</span>(sim.dat)[-<span class="kw">c</span>(<span class="dv">1</span>:<span class="dv">4</span>)]])
X1 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X1&quot;</span>]; X2 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X2&quot;</span>]; X3 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X3&quot;</span>]; X4 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X4&quot;</span>]; X5 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X5&quot;</span>];X6 &lt;-<span class="st"> </span>X[,<span class="st">&quot;X6&quot;</span>]

<span class="co"># outcome: treatment effect is zero</span>
u  &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(X))
<span class="co"># ouctome (linear)</span>
Y &lt;-<span class="st">    </span>(W==<span class="dv">1</span>)*(  X1 +<span class="st">   </span>X2 +<span class="st">   </span>X3 +<span class="st">   </span>X4 +<span class="st">    </span>X5<span class="dv">-1</span> +<span class="st">     </span>X6<span class="fl">-0.5</span>)+
(W==<span class="dv">2</span>)*(<span class="dv">2</span>*X1 +<span class="st"> </span><span class="dv">3</span>*X2 +<span class="st">   </span>X3 +<span class="st"> </span><span class="dv">2</span>*X4 +<span class="st"> </span><span class="dv">2</span>*(X5<span class="dv">-1</span>) +<span class="st"> </span><span class="dv">2</span>*(X6<span class="fl">-0.5</span>))+
(W==<span class="dv">3</span>)*(<span class="dv">3</span>*X1 +<span class="st">   </span>X2 +<span class="st"> </span><span class="dv">2</span>*X3 -<span class="st">   </span>X4 -<span class="st">   </span>(X5<span class="dv">-1</span>) -<span class="st">   </span>(X6<span class="fl">-0.5</span>))+u

match1&lt;-<span class="kw">multilevelMatchX</span>(Y,W,X)
match2&lt;-<span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="ot">FALSE</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>)
match3&lt;-<span class="kw">multilevelGPSMatch</span>(Y,W,X,<span class="dt">Trimming=</span><span class="ot">TRUE</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>)
match4&lt;-<span class="kw">multilevelGPSStratification</span>(Y,W,X,<span class="dt">NS=</span><span class="dv">10</span>,<span class="dt">GPSM=</span><span class="st">&quot;multinomiallogisticReg&quot;</span>,<span class="dt">linearp=</span><span class="dv">0</span>,<span class="dt">nboot=</span><span class="dv">50</span>)


match1$results</code></pre></div>
<pre><code>##         Param Trt1 Trt2   Estimate  Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2 0.07927361 0.1792186             NA
## 2 EY(3)-EY(1)    1    3 0.86264929 0.1634754             NA
## 3 EY(3)-EY(2)    2    3 0.78337567 0.3221616             NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">match2$results</code></pre></div>
<pre><code>##         Param Trt1 Trt2   Estimate  Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2 -0.7458499 0.6974908      0.4340571
## 2 EY(3)-EY(1)    1    3  0.5605192 0.4856579      0.2287787
## 3 EY(3)-EY(2)    2    3  1.3063691 0.7089620      0.4226466</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">match3$results</code></pre></div>
<pre><code>##         Param Trt1 Trt2  Estimate  Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2 -1.056445 0.7924310      0.4876396
## 2 EY(3)-EY(1)    1    3  1.001189 0.4457239      0.2104603
## 3 EY(3)-EY(2)    2    3  2.057634 0.8310264      0.4624069</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">match4$results</code></pre></div>
<pre><code>##         Param Trt1 Trt2   Estimate  Variance VarianceAI2012
## 1 EY(2)-EY(1)    1    2 -0.3077249 0.3515320             NA
## 2 EY(3)-EY(1)    1    3  0.4170466 0.2412386             NA
## 3 EY(3)-EY(2)    2    3  0.7247715 0.4906146             NA</code></pre>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
